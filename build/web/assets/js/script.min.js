//------------------------------------------------------------------------------
/**
 * iniciacion de variables;;
 * @author Adrian
 * @type jQuery
 */
const BASE = $("#base").val();
const ANIMATED_GROUP_OUT = [
    "zoomOutRight", "zoomOutLeft",
    "fadeOutRight", "fadeOutLeft"
];
//------------------------------------------------------------------------------
$(document).ready(function () {
    $(".navbar-toggler").on("click", function () {
        $("body").toggleClass("navbar--opened");
    });

    $('[data-toggle="tooltip"]').tooltip();

    //--------------------------------------------------------------------------
    // inicio de funciones 
    //--------------------------------------------------------------------------
    isVisible();
    load_count_shopping();
    totalShoppingCart();
    //add_cart();

    //--------------------------------------------------------------------------
    var col_size = $("#col-size").val();
    //alert(col_size);
    if (col_size == 0)
        $("#carousel-example-generic").html("<p>NADA AGREGADO!</p>");
    if (col_size <= 1) {
        $(".col-setting").removeClass("col-md-4").addClass("col-md-12");
    } else if (col_size == 2) {
        $(".col-setting").removeClass("col-md-4").addClass("col-md-6");
    }


});
/**
 * 
 * @param {this} idCheck : input customizado
 * @returns {undefined}
 */
function isVisible(idCheck) {
    let v = $("#visible");
    let msg = "";
    let icon = "";

    if (idCheck === undefined)
        idCheck = "#visible-input";

    if ($(idCheck).is(':checked')) {
        v.prop("value", "1");
        msg = "Visible";
        icon = `<i class="far fa-eye text-success"></i>`;
    } else {
        v.prop("value", "0");
        msg = "oculto";
        icon = `<i class="far fa-eye-slash text-warning"></i>`;
    }
    $(".visible-input-msg").html(`${msg} ${icon}`);
}

$("#t-show").on('click', function (event) {
    event.preventDefault();
    $(".t-hidden").removeClass("d-none");
    $(this).addClass("d-none");
    $("#t-hide").removeClass("d-none");
});

$("#t-hide").on('click', function (event) {
    event.preventDefault();
    $(".t-hidden").addClass("d-none");
    $(this).addClass("d-none");
    $("#t-show").removeClass("d-none");
});

/**
 * Agregar nuevos al carrito de compras 
 * @param {type} that
 * @param {type} product_id
 * @param {type} order_id
 * @param {type} price
 * @param {type} stock
 * @returns {undefined}
 */
function add_cart(that, product_id, order_id, price, stock) {
    if (stock > 0) {
        $.ajax({
            url: BASE + "/order_items",
            data: {
                "type": "verific_product",
                "price": price,
                "products_id": product_id,
                "orders_id": order_id
            },
            type: "GET",
            datatype: "html"
        }).done(function (res) {
            if (res == "true") {
                $(that).html("Agregado <i class='fas fa-check'> </i>")
                        .removeClass("btn-dark")
                        .addClass("btn-success");
                load_count_shopping();
            } else if (res == "false") {
                $(that).html("En el carrito! <i class='far fa-1x fa-laugh-squint'></i>")
                        .prop("disabled", true)
                        .removeClass("btn-dark btn-success")
                        .addClass("btn-outlet-info");
                $("#nav-shopping-cart").addClass("animated tada")
            } else {
                $(that).html("Ninguna Accion Realizada <i class='fas fa-bug'></i>")
                        .removeClass("btn-dark btn-success btn-outlet-info")
                        .addClass("btn-danger");
            }
        });
    } else {
        $(that).html("Sin Stock <i class='far fa-1x fa-sad-cry'></i>")
                .prop("disabled", true)
                .removeClass("btn-dark btn-success btn-outlet-info")
                .addClass("btn-warning");
    }
}

/**
 * 
 * @param {this} that
 * @param {number} id
 * @returns {undefined}
 */
function updateQuantity(that, id) {
    var quantity = that.value;
    var stock = $("#stock" + id).val();
    //alert(quantity)
    if (quantity > 0) {
        //alert(stock);
        var name = $("#name" + id).val();
        //alert(Number(quantity) + Number(stock))
        if (Number(quantity) <= Number(stock)) {
            var price_pro = $("#price_pro" + id).val();
            //alert(Number(price_pro))
            $.ajax({
                url: BASE + "/order_items",
                data: {
                    "type": "update_quantity",
                    "quantity": quantity,
                    "price_pro": Number(price_pro),
                    "id": id
                },
                type: "get",
                dataType: "html"
            }).done(function (res) {
                //alert(res)
                $("#sub_total_pro" + id + "label").html(res);

                var config_alert = {
                    animated: "fadeInUp",
                    type: "success",
                    msg: `La cantidad del producto <b>"${name}"</b> se a modificado`,
                    icon: ` <i class="fas fa-check"></i>`,
                    class_: "text-center"
                };
                load_count_shopping();
                totalShoppingCart();
                $("#msg-shooping-cart").html(__template_alert(config_alert));
            }).fail(function (jqXhr, txtStatus, error) {

            });
        } else {
            $(that).prop("value", quantity - 1);
            //let name = $("#name" + id).val();
            var config_alert = {
                animated: "fadeInUp",
                type: "warning",
                msg: `El producto <b>"${name}"</b>tiene ${stock} cantidades disponibles`,
                icon: `<i class="far fa-dizzy"></i>`,
                class_: "text-center"
            };
            $("#msg-shooping-cart").html(__template_alert(config_alert));
        }
    }
    //alert(formatPrice(price))
    //alert(that.value + " -> " + id + "-->" + price)
}

/**
 * 
 * @param {number} i
 * @returns {undefined}
 */
function deleteOrder(i) {
    let question = confirm("¿ Esta seguro de remover este producto ?");
    if (question) {
        $.ajax({
            url: BASE + "/order_items",
            data: {
                "type": "delete_order",
                "id": i
            },
            type: "post",
            dataType: "html"
        }).done(function (res) {
            if (res === "true") {
                let name = $("#name" + i).val();
                var config_alert = {
                    animated: "animated fadeInUp",
                    type: "warning",
                    msg: `El producto <b>${name}</b> ha sido removido!`,
                    icon: `<i class="far fa-smile-wink"></i>`,
                    class_: "text-center"
                };
                $("#msg-shooping-cart").html(__template_alert(config_alert));

                var random = Math.floor(Math.random() * ANIMATED_GROUP_OUT.length);
                //alert(ANIMATED_GROUP[random]);
                $("#row_order" + i).addClass("animated " + ANIMATED_GROUP_OUT[random]);
                setTimeout(function () {
                    $("#row_order" + i).remove();
                }, 1500);
                //$(".count-shopping-cart").addClass("animated tada");
                load_count_shopping();
                totalShoppingCart();
            } else {
                load_count_shopping();
                totalShoppingCart();
            }
        }).fail(function (jq, ts, e) {
            alert(jq + " --> " + ts);
        });
    }
}

/**
 * 
 * @returns {undefined}
 */
function totalShoppingCart() {
    const ORDERS_ID = $("#orders_id").val();
    $.ajax({
        url: BASE + "/order_items",
        data: {
            type: "total_shopping_cart",
            id: ORDERS_ID
        },
        type: "get",
        dataType: "html"
    }).done(function (res) {
        if (res === "0") {
            $("#shopping-cart-payment").prop({"disabled": true, "title": "Agrega productos al carrito :)"});
            $(".count-shopping-cart").html("0");
            var config_alert = {
                animated: "animated fadeInUp",
                type: "info",
                msg: `Añade productos al carrito, <a href="${BASE}/index.jsp">Ir a tienda</a>`,
                icon: `<i class="far fa-smile"></i>`,
                class_: "text-center"
            };
            $(".msg-empty-cart").html(__template_alert(config_alert));
        }
        $("#monto_total").html("$" + formatPrice(Number(res)));
    }).fail(function (jqXhr, txtStatus, error) {

    });
}

//------------------------------------------------------------------------------
// Helpers
//------------------------------------------------------------------------------
/**
 * 
 * @param {type} number
 * @returns {String}
 */
function formatPrice(number) {
    number = String(number).replace(/\D/g, "");
    return number === "" ? number : Number(number).toLocaleString();
}

/**
 * 
 * @param {object} config
 * animated, type, msg, icon, class_
 * @returns {String}
 */
function __template_alert(config) {
    if (config.class_ === null)
        config.class_ = "";
    return `
        <div class="alert alert-${config.type} alert-dismissible animated ${config.animated} show ${config.class_}" role="alert">
            ${config.msg} ${config.icon}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    `;
}